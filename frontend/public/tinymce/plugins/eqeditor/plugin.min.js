tinymce.PluginManager.add("eqeditor",function(r,e){var d=!1,p=0;function a(e,t){var n,i="eqinput-"+ ++p,a="eqpreview-"+p,o=null;function c(){var e=$("#"+i).val();if(o!==e){clearTimeout(n);try{katex.render(e,document.getElementById(a))}catch(e){null!==(e=e.message.match(/^KaTeX parse error: (.*)/))&&(n=setTimeout(function(){$("#"+a).html('<span style="color:#ff9b9b">'+e[1]+"</span>")},1e3))}o=e}}if(void 0!==t)d=t.inline;else{var l=r.selection.getNode().innerText;d=""!==l.replace(/\s+/g,"")}win=r.windowManager.open({title:"ویراستار فرمول ریاضی",items:[{type:"container",name:"main",label:"معادله را اینجا بنویس",html:'<div style="padding: 10px;"><p class="mce-rtl">فرمول LaTeX موردنظر را در این کادر وارد کنید. (<a target="_blank" href="http://mathysc.com/sites/default/files/pdf/LaTeX_MathJax_Persian_Tutorial.pdf">راهنما</a>)</p><textarea id="'+i+'" rows="2" cols="50" placeholder="\\sum" style="border: solid 3px #00c5ff; margin: 5px; padding: 10px; width: 500px;"></textarea><p  class="mce-rtl">پیش‌نمایش:</p><div style="padding:20px; height: 50px"><p class="mce-eqpreview" style="font-size: 14px!important; text-align: center;" id ="'+a+'"></p></div></div>'}],buttons:[{type:"checkbox",name:"checkbox",label:"checkbox",text:"میان‌خط",checked:d,onchange:function(){d=this.checked()}},{type:"spacer",flex:1},{text:"Ok",subtype:"primary",minWidth:50,onclick:function(){if(d)var e='<span dir="ltr">$'+$("#"+i).val()+"$</span> ";else e='<span dir="ltr">$$'+$("#"+i).val()+"$$</span>";void 0!==t&&r.execCommand("mceSelectNode",!1,r.selection.getNode()),r.execCommand("mceInsertContent",!1,e),win.close()}},{text:"Cancel",onclick:function(){win.close()}}]}),void 0!==t&&($("#"+i).val(t.text),c()),$("body").on("change keyup","#"+i,c),$("#"+i).focus()}r.addButton("eqeditor",{title:"Equation",image:e+"/img/eqeditor.png",tooltip:"درج فرمول ریاضی",onclick:a}),r.addMenuItem("eqeditor",{image:e+"/img/eqeditor.png",text:"درج فرمول ریاضی",context:"insert",prependToContext:!0,onclick:a}),r.on("DblClick",function(e,t){var n=e.target.nodeName.toLowerCase();if("p"==n||"span"==n){var i=e.target.innerHTML.match(/^(\${1,2})(.*)\1$/);null!=i&&a(0,{text:i[2],inline:"$"==i[1]})}})});